import{t as he,r as n,c as U,w as ue,b as pe,j as e,C as u,d as p,a0 as z,a1 as q,e as W,f as X,I as L,S as A,m as F,n as P,p as R,q as t,s as _,P as D,o as $,B as l,x as T,D as je,z as fe}from"./index-BRVCUzIT.js";import{a as G}from"./dropdown-menu-DdnnckdS.js";import{D as ge,a as Ne,b as ve,c as we,e as ye}from"./dialog-D51Jx8ed.js";import{P as J}from"./page-wrapper-D2Xzdxb4.js";import{F as Y}from"./file-text-Bxr2bFQ2.js";import{C as be}from"./clock-eFLI6NpM.js";import{F as Ce}from"./filter-CAt8Zx1u.js";import{S as Se}from"./search-DbNGpwvW.js";import{E as ke}from"./eye-Bk7S5FeN.js";import{S as Ae}from"./square-pen-BSPv7dcA.js";import"./index-uwi08Yf3.js";function Be(){var O,H,Q;const{toast:V}=he(),[g,Z]=n.useState(""),[N,ee]=n.useState("all"),[v,se]=n.useState("all"),[a,M]=n.useState(null),[ae,x]=n.useState(!1),[j,w]=n.useState(""),[f,y]=n.useState(!1),[o,b]=n.useState({status:"pending",adminComment:""}),[c,E]=n.useState(1),I=10,{data:d,isLoading:te}=U({queryKey:["/api/requests"]}),{data:B,isLoading:Fe}=U({queryKey:["/api/admin/families"]}),i=ue({mutationFn:async({id:s,status:r,adminComment:h})=>(await fe("PUT",`/api/requests/${s}`,{status:r,adminComment:h})).data,onSuccess:()=>{je.invalidateQueries({queryKey:["/api/requests"]}),x(!1),M(null),w(""),V({title:"تم تحديث الطلب",description:"تم تحديث حالة الطلب بنجاح"})},onError:s=>{V({title:"خطأ في التحديث",description:s.message,variant:"destructive"})}}),C=Array.isArray(d)?d.filter(s=>{const r=s.description.toLowerCase().includes(g.toLowerCase())||s.id.toString().includes(g),h=N==="all"||s.status===N,k=v==="all"||s.type===v;return r&&h&&k}):[],K=Math.ceil(C.length/I),le=C.slice((c-1)*I,c*I),de=s=>{let r=s;if(!s.family&&Array.isArray(B)){const h=B.find(k=>k.id===s.familyId);h&&(r={...s,family:h})}M(r),w(s.adminComment||""),x(!0),y(!1)},S=s=>{a&&i.mutate({id:a.id,status:s,adminComment:j.trim()||void 0})},ie=()=>{y(!0),b({status:a.status,adminComment:a.adminComment||""})},ne=()=>{y(!1),b({status:a.status,adminComment:a.adminComment||""})},re=()=>{a&&(i.mutate({id:a.id,status:o.status,adminComment:o.adminComment.trim()||void 0}),y(!1))},{settings:m}=pe();if(n.useEffect(()=>{m.siteTitle&&(document.title=m.siteTitle),m.language&&(document.documentElement.lang=m.language,document.body.dir=m.language==="ar"?"rtl":"ltr")},[m.siteTitle,m.language]),te)return e.jsx(J,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-lg text-muted-foreground",children:"جاري تحميل البيانات..."})})});const ce=Array.isArray(d)?d.length:0,me=Array.isArray(d)?d.filter(s=>s.status==="pending"):[],xe=Array.isArray(d)?d.filter(s=>s.status==="approved"):[],oe=Array.isArray(d)?d.filter(s=>s.status==="rejected"):[];return e.jsx(J,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-2",children:"إدارة الطلبات"}),e.jsx("p",{className:"text-muted-foreground",children:"مراجعة والرد على طلبات الأسر"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8",children:[e.jsx(u,{children:e.jsx(p,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-blue-100 rounded-lg",children:e.jsx(Y,{className:"h-5 w-5 md:h-6 md:w-6 text-primary"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"إجمالي الطلبات"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:ce})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-yellow-100 rounded-lg",children:e.jsx(be,{className:"h-5 w-5 md:h-6 md:w-6 text-warning"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"قيد المراجعة"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:me.length})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-green-100 rounded-lg",children:e.jsx(z,{className:"h-5 w-5 md:h-6 md:w-6 text-secondary"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"موافق عليها"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:xe.length})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-red-100 rounded-lg",children:e.jsx(q,{className:"h-5 w-5 md:h-6 md:w-6 text-destructive"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"مرفوضة"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:oe.length})]})]})})})]}),e.jsxs(u,{className:"mb-8",children:[e.jsx(W,{children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"البحث والتصفية"]})}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-3 md:space-y-0 md:grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative md:col-span-1",children:[e.jsx(Se,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(L,{placeholder:"البحث برقم الطلب أو الوصف...",value:g,onChange:s=>Z(s.target.value),className:"pr-10 w-full"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:col-span-2 md:grid-cols-2",children:[e.jsxs(A,{value:N,onValueChange:ee,children:[e.jsx(F,{children:e.jsx(P,{placeholder:"تصفية بالحالة"})}),e.jsxs(R,{children:[e.jsx(t,{value:"all",children:"جميع الحالات"}),e.jsx(t,{value:"pending",children:"قيد المراجعة"}),e.jsx(t,{value:"approved",children:"موافق عليها"}),e.jsx(t,{value:"rejected",children:"مرفوضة"})]})]}),e.jsxs(A,{value:v,onValueChange:se,children:[e.jsx(F,{children:e.jsx(P,{placeholder:"تصفية بالنوع"})}),e.jsxs(R,{children:[e.jsx(t,{value:"all",children:"جميع الأنواع"}),e.jsx(t,{value:"financial",children:"مساعدة مالية"}),e.jsx(t,{value:"medical",children:"مساعدة طبية"}),e.jsx(t,{value:"damage",children:"تقرير أضرار"})]})]})]})]})})]}),e.jsxs(u,{children:[e.jsx(W,{children:e.jsxs(X,{children:["قائمة الطلبات (",C.length,")"]})}),e.jsx(p,{children:C.length>0?e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-background",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"رقم الطلب"}),e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"نوع الطلب"}),e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider hidden md:table-cell",children:"الوصف"}),e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider hidden lg:table-cell",children:"التاريخ"}),e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"الحالة"}),e.jsx("th",{className:"px-3 md:px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"الإجراءات"})]})}),e.jsx("tbody",{className:"bg-card divide-y divide-border",children:le.map(s=>e.jsxs("tr",{className:"hover:bg-muted",children:[e.jsxs("td",{className:"px-3 md:px-6 py-4 whitespace-nowrap text-sm text-foreground",children:["#",s.id]}),e.jsx("td",{className:"px-3 md:px-6 py-4 whitespace-nowrap text-sm text-foreground",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:_(s.type)}),e.jsx("span",{className:"lg:hidden text-xs text-muted-foreground mt-1",children:D(s.createdAt)}),e.jsx("span",{className:"md:hidden text-xs text-muted-foreground mt-1 truncate max-w-32",children:s.description})]})}),e.jsx("td",{className:"px-3 md:px-6 py-4 text-sm text-foreground max-w-xs truncate hidden md:table-cell",children:s.description}),e.jsx("td",{className:"px-3 md:px-6 py-4 whitespace-nowrap text-sm text-muted-foreground hidden lg:table-cell",children:D(s.createdAt)}),e.jsx("td",{className:"px-3 md:px-6 py-4 whitespace-nowrap",children:e.jsx(G,{variant:s.status==="pending"?"default":s.status==="approved"?"success":"destructive",className:"text-xs",children:$(s.status)})}),e.jsx("td",{className:"px-3 md:px-6 py-4 whitespace-nowrap text-sm",children:e.jsxs("div",{className:"flex flex-wrap gap-1 md:flex-nowrap md:space-x-2 md:space-x-reverse",children:[e.jsx(l,{variant:"outline",size:"sm",onClick:()=>de(s),disabled:i.isPending,className:"w-8 h-8 p-0",children:e.jsx(ke,{className:"h-4 w-4"})}),s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"outline",size:"sm",className:"text-secondary w-8 h-8 p-0",onClick:()=>S("approved"),disabled:i.isPending,children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx(l,{variant:"outline",size:"sm",className:"text-destructive w-8 h-8 p-0",onClick:()=>S("rejected"),disabled:i.isPending,children:e.jsx(q,{className:"h-4 w-4"})})]})]})})]},s.id))})]}),e.jsxs("div",{className:"flex justify-center items-center gap-2 mt-4 flex-wrap",children:[e.jsx(l,{variant:"outline",size:"sm",disabled:c===1,onClick:()=>E(c-1),children:"السابق"}),e.jsx("div",{className:"flex gap-1 flex-wrap justify-center",children:Array.from({length:K},(s,r)=>r+1).map(s=>e.jsx(l,{variant:s===c?"default":"outline",size:"sm",onClick:()=>E(s),className:"min-w-8",children:s},s))}),e.jsx(l,{variant:"outline",size:"sm",disabled:c===K,onClick:()=>E(c+1),children:"التالي"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Y,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:g||N!=="all"||v!=="all"?"لم يتم العثور على طلبات تطابق المعايير":"لا توجد طلبات"})]})})]}),e.jsx(ge,{open:ae,onOpenChange:x,children:e.jsxs(Ne,{className:"max-w-2xl w-[95vw] md:w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"text-center",children:["تفاصيل الطلب #",a==null?void 0:a.id]}),e.jsx(ye,{className:"text-center",children:"عرض تفاصيل الطلب مع إمكانية الموافقة أو الرفض"})]}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"معلومات الطلب"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"نوع الطلب:"}),e.jsx("span",{className:"font-medium",children:_(a.type)})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"الحالة:"}),e.jsx(G,{variant:a.status==="pending"||a.status==="approved"?"default":"destructive",children:$(a.status)})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"تاريخ التقديم:"}),e.jsx("span",{className:"font-medium",children:D(a.createdAt)})]}),a.updatedAt&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"آخر تحديث:"}),e.jsx("span",{className:"font-medium",children:D(a.updatedAt)})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"معلومات مقدم الطلب"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"اسم رب الأسرة:"}),e.jsx("span",{className:"font-medium text-right",children:((O=a.family)==null?void 0:O.husbandName)||"غير محدد"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"رقم الهوية:"}),e.jsx("span",{className:"font-medium",children:((H=a.family)==null?void 0:H.husbandID)||"غير محدد"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"رقم الجوال:"}),e.jsx("span",{className:"font-medium",children:((Q=a.family)==null?void 0:Q.primaryPhone)||"غير محدد"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"الوصف:"}),e.jsx("span",{className:"font-medium text-right break-words",children:a.description||"غير محدد"})]}),a.adminComment&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"التعليق الإداري:"}),e.jsx("span",{className:"font-medium text-right text-blue-600 break-words",children:a.adminComment})]})]})]})]}),a.status==="pending"&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsx("h4",{className:"font-semibold text-foreground",children:f?"تعديل حالة الطلب":"إجراء على الطلب"}),f&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"editStatus",children:"حالة الطلب"}),e.jsxs(A,{value:o.status,onValueChange:s=>b({...o,status:s}),children:[e.jsx(F,{children:e.jsx(P,{placeholder:"اختر حالة الطلب"})}),e.jsxs(R,{children:[e.jsx(t,{value:"pending",children:"معلق"}),e.jsx(t,{value:"approved",children:"تمت الموافقة"}),e.jsx(t,{value:"rejected",children:"مرفوض"})]})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(T,{htmlFor:"adminComment",children:"تعليق إداري"}),e.jsx(L,{id:"adminComment",placeholder:"أضف تعليقاً إدارياً (اختياري)",value:j,onChange:s=>w(s.target.value)})]}),!f&&e.jsx(l,{variant:"secondary",disabled:i.isPending||j.trim()===(a.adminComment||"").trim(),onClick:()=>{i.mutate({id:a.id,status:a.status,adminComment:j.trim()||void 0})},className:"w-full sm:w-auto whitespace-nowrap",children:"حفظ التعليق"})]})})]}),f&&a.status!=="pending"&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsx("h4",{className:"font-semibold text-foreground",children:"تعديل حالة الطلب"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"editStatus",children:"حالة الطلب"}),e.jsxs(A,{value:o.status,onValueChange:s=>b({...o,status:s}),children:[e.jsx(F,{children:e.jsx(P,{placeholder:"اختر حالة الطلب"})}),e.jsxs(R,{children:[e.jsx(t,{value:"pending",children:"معلق"}),e.jsx(t,{value:"approved",children:"تمت الموافقة"}),e.jsx(t,{value:"rejected",children:"مرفوض"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"adminComment",children:"تعليق إداري"}),e.jsx(L,{id:"adminComment",placeholder:"أضف تعليقاً إدارياً (اختياري)",value:j,onChange:s=>w(s.target.value)})]})]}),e.jsx("div",{className:"flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-0 sm:space-x-3 sm:space-x-reverse pt-4 border-t",children:f?e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"outline",onClick:ne,className:"w-full sm:w-auto",children:"إلغاء التعديل"}),e.jsx(l,{className:"bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto",onClick:re,disabled:i.isPending,children:"حفظ التعديلات"})]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"outline",onClick:()=>x(!1),className:"w-full sm:w-auto",children:a.status==="pending"?"إلغاء":"إغلاق"}),e.jsxs(l,{variant:"outline",onClick:ie,className:"w-full sm:w-auto",children:[e.jsx(Ae,{className:"h-4 w-4 ml-2"}),"تعديل"]}),a.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(l,{variant:"outline",className:"text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200 w-full sm:w-auto",onClick:()=>{S("rejected"),x(!1)},disabled:i.isPending,children:[e.jsx(q,{className:"h-4 w-4 ml-2"}),"رفض الطلب"]}),e.jsxs(l,{className:"bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto",onClick:()=>{S("approved"),x(!1)},disabled:i.isPending,children:[e.jsx(z,{className:"h-4 w-4 ml-2"}),"موافقة"]})]})]})})]})]})})]})})}export{Be as default};
