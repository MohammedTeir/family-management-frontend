import{Q as re,t as le,r as l,c as D,b as de,v as ne,w as ce,j as e,B as d,C as N,d as v,U as T,e as q,f as M,R as ie,P as E,x as y,I as z,S as V,m as F,n as I,p as L,q as n,A as me,D as xe,z as he,E as oe,a2 as ue,F as ge,G as O,a3 as pe}from"./index-BRVCUzIT.js";import{T as je}from"./textarea-D5X74VJL.js";import{D as fe,a as Ne,b as ve,c as be}from"./dialog-D51Jx8ed.js";import{B as $,a as u}from"./dropdown-menu-DdnnckdS.js";import{P as K}from"./page-wrapper-D2Xzdxb4.js";import{P as we}from"./plus-B3M91HrX.js";import"./index-uwi08Yf3.js";import"./file-text-Bxr2bFQ2.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=re("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),ye=oe({title:O().min(1,"العنوان مطلوب"),message:O().min(10,"الرسالة يجب أن تكون 10 أحرف على الأقل"),target:ge(["all","head","admin","specific","urgent"],{required_error:"نوع المستقبل مطلوب"}),recipients:ue(pe()).optional()});function Pe(){const{toast:A}=le(),[R,c]=l.useState(!1),[b,H]=l.useState(""),[g,Q]=l.useState("all"),[p,U]=l.useState("all"),[m,S]=l.useState(1),C=10,{data:x,isLoading:W}=D({queryKey:["/api/notifications"]}),{data:a,isLoading:_}=D({queryKey:["/api/admin/families"]}),{data:j,isLoading:Se}=D({queryKey:["/api/admin/users"]}),{settings:h}=de();l.useEffect(()=>{h.siteTitle&&(document.title=h.siteTitle),h.language&&(document.documentElement.lang=h.language,document.body.dir=h.language==="ar"?"rtl":"ltr")},[h.siteTitle,h.language]);const t=ne({resolver:me(ye),defaultValues:{title:"",message:"",target:"all",recipients:[]}});l.useEffect(()=>{t.watch("target")!=="specific"&&t.setValue("recipients",[])},[t.watch("target")]);const G=l.useMemo(()=>a?Array.from(new Set(a.map(s=>s.branch).filter(Boolean))):[],[a]),J=l.useMemo(()=>a?Array.from(new Set(a.map(s=>s.socialStatus).filter(Boolean))):[],[a]);l.useMemo(()=>j?j.filter(s=>s.role==="admin"):[],[j]);const X=l.useMemo(()=>a?a.filter(s=>{const r=s.husbandName.toLowerCase().includes(b.toLowerCase())||s.husbandID.includes(b),o=g==="all"||s.branch===g,i=p==="all"||s.socialStatus===p;return r&&o&&i}):[],[a,b,g,p]),k=ce({mutationFn:async s=>(await he("POST","/api/notifications",s)).data,onSuccess:()=>{xe.invalidateQueries({queryKey:["/api/notifications"]}),c(!1),t.reset(),A({title:"تم إرسال التنبيه",description:"تم إرسال التنبيه بنجاح إلى المستقبلين"})},onError:s=>{A({title:"خطأ في الإرسال",description:s.message,variant:"destructive"})}}),Y=s=>{k.mutate(s)},Z=s=>{switch(s){case"all":return"جميع المستخدمين";case"head":return"رؤساء الأسر";case"admin":return"المشرفين";case"urgent":return"تنبيه عاجل";case"specific":return"محدد";default:return s}},ee=s=>s.target==="urgent"?e.jsx(u,{className:"bg-red-600 text-white",children:"عاجل"}):s.target==="success"?e.jsx(u,{className:"bg-green-600 text-white",children:"نجاح"}):s.target==="head"?e.jsx(u,{className:"bg-purple-600 text-white",children:"رؤساء الأسر"}):s.target==="admin"?e.jsx(u,{className:"bg-orange-500 text-white",children:"مشرفين"}):s.target==="all"?e.jsx(u,{className:"bg-background0 text-white",children:"الكل"}):s.target==="specific"?e.jsx(u,{className:"bg-teal-600 text-white",children:"محدد"}):e.jsx(u,{variant:"default",children:"معلومات"});if(W||_)return e.jsx(K,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"text-lg text-muted-foreground",children:"جاري تحميل البيانات..."})})});const se=(x==null?void 0:x.length)||0,te=(x==null?void 0:x.filter(s=>{const r=new Date;return r.setDate(r.getDate()-7),new Date(s.createdAt)>r}))||[],w=x||[],B=Math.ceil(w.length/C),ae=w.slice((m-1)*C,m*C);return e.jsx(K,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-2",children:"قائمة التنبيهات"}),e.jsx("p",{className:"text-muted-foreground",children:"إرسال تنبيهات ورسائل للمستخدمين"})]}),e.jsxs(d,{onClick:()=>c(!0),className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx(we,{className:"h-4 w-4"}),"إرسال تنبيه جديد"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8",children:[e.jsx(N,{children:e.jsx(v,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-blue-100 rounded-lg",children:e.jsx($,{className:"h-5 w-5 md:h-6 md:w-6 text-primary"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"إجمالي التنبيهات"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:se})]})]})})}),e.jsx(N,{children:e.jsx(v,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-green-100 rounded-lg",children:e.jsx(P,{className:"h-5 w-5 md:h-6 md:w-6 text-secondary"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"هذا الأسبوع"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:te.length})]})]})})}),e.jsx(N,{className:"sm:col-span-2 lg:col-span-1",children:e.jsx(v,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 md:p-3 bg-purple-100 rounded-lg",children:e.jsx(T,{className:"h-5 w-5 md:h-6 md:w-6 text-purple-600"})}),e.jsxs("div",{className:"mr-3 md:mr-4",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"المستقبلين النشطين"}),e.jsx("p",{className:"text-xl md:text-2xl font-bold text-foreground",children:(a==null?void 0:a.length)||0})]})]})})})]}),e.jsxs(N,{className:"mb-8",children:[e.jsx(q,{children:e.jsx(M,{children:"إرسال سريع"})}),e.jsx(v,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:[e.jsxs(d,{variant:"outline",className:"h-auto p-4 justify-start",onClick:()=>{t.setValue("title","تنبيه عاجل"),t.setValue("target","urgent"),c(!0)},children:[e.jsx(ie,{className:"h-4 w-4 md:h-5 md:w-5 ml-2 md:ml-3 text-accent flex-shrink-0"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm md:text-base",children:"تنبيه عاجل"}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"لجميع المستخدمين (بارز)"})]})]}),e.jsxs(d,{variant:"outline",className:"h-auto p-4 justify-start",onClick:()=>{t.setValue("title","إشعار لرؤساء الأسر"),t.setValue("target","head"),c(!0)},children:[e.jsx(T,{className:"h-4 w-4 md:h-5 md:w-5 ml-2 md:ml-3 text-secondary flex-shrink-0"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm md:text-base",children:"إشعار لرؤساء الأسر"}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"رؤساء الأسر فقط"})]})]}),e.jsxs(d,{variant:"outline",className:"h-auto p-4 justify-start md:col-span-2 xl:col-span-1",onClick:()=>{t.setValue("title","إشعار للمشرفين"),t.setValue("target","admin"),c(!0)},children:[e.jsx(T,{className:"h-4 w-4 md:h-5 md:w-5 ml-2 md:ml-3 text-orange-500 flex-shrink-0"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-sm md:text-base",children:"إشعار للمشرفين"}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"جميع المشرفين فقط"})]})]})]})})]}),e.jsxs(N,{children:[e.jsx(q,{children:e.jsxs(M,{children:["قائمة التنبيهات (",w.length,")"]})}),e.jsx(v,{children:w.length>0?e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-background",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground",children:"العنوان"}),e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground hidden md:table-cell",children:"الرسالة"}),e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground",children:"الهدف"}),e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground hidden lg:table-cell",children:"المستقبلين"}),e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground hidden sm:table-cell",children:"تاريخ الإرسال"}),e.jsx("th",{className:"py-2 px-2 md:px-4 text-left text-xs md:text-sm font-semibold text-muted-foreground hidden xl:table-cell",children:"من"})]})}),e.jsx("tbody",{children:ae.map(s=>e.jsxs("tr",{className:"hover:bg-muted",children:[e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.title}),e.jsx("span",{className:"md:hidden text-xs text-muted-foreground mt-1 truncate max-w-32",children:s.message}),e.jsx("span",{className:"sm:hidden text-xs text-muted-foreground mt-1",children:E(s.createdAt)})]})}),e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground hidden md:table-cell",children:e.jsx("span",{className:"max-w-xs truncate block",children:s.message})}),e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs",children:Z(s.target)}),ee(s),e.jsx("span",{className:"lg:hidden text-xs text-muted-foreground mt-1",children:s.target==="head"&&(!s.recipients||s.recipients.length===0)?"جميع رؤساء الأسر":s.target==="admin"&&(!s.recipients||s.recipients.length===0)?"جميع المشرفين":s.recipients&&s.recipients.length>0?`${s.recipients.length} مستخدم`:"جميع المستخدمين"})]})}),e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground hidden lg:table-cell",children:s.target==="head"&&(!s.recipients||s.recipients.length===0)?"جميع رؤساء الأسر":s.target==="admin"&&(!s.recipients||s.recipients.length===0)?"جميع المشرفين":s.recipients&&s.recipients.length>0?s.recipients.map(r=>{const o=j==null?void 0:j.find(f=>f.id===r);if(o)return`${o.username} (${o.phone||"بدون رقم"})`;const i=a==null?void 0:a.find(f=>f.userId===r);return i?`${i.husbandName} (${i.husbandID})`:r}).join(", "):"جميع المستخدمين"}),e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground hidden sm:table-cell",children:E(s.createdAt)}),e.jsx("td",{className:"py-2 px-2 md:px-4 text-xs md:text-sm text-foreground hidden xl:table-cell",children:"الإدارة"})]},s.id))})]}),e.jsxs("div",{className:"flex justify-center items-center gap-2 mt-4 flex-wrap",children:[e.jsx(d,{variant:"outline",size:"sm",disabled:m===1,onClick:()=>S(m-1),children:"السابق"}),e.jsx("div",{className:"flex gap-1 flex-wrap justify-center",children:Array.from({length:B},(s,r)=>r+1).map(s=>e.jsx(d,{variant:s===m?"default":"outline",size:"sm",onClick:()=>S(s),className:"min-w-8",children:s},s))}),e.jsx(d,{variant:"outline",size:"sm",disabled:m===B,onClick:()=>S(m+1),children:"التالي"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx($,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"لم يتم إرسال أي تنبيهات بعد"}),e.jsx(d,{onClick:()=>c(!0),className:"mt-4",children:"إرسال أول تنبيه"})]})})]}),e.jsx(fe,{open:R,onOpenChange:c,children:e.jsxs(Ne,{className:"max-w-2xl w-[95vw] md:w-full max-h-[90vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsx(be,{children:"إرسال تنبيه جديد"})}),e.jsxs("form",{onSubmit:t.handleSubmit(Y),className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(y,{htmlFor:"title",children:"عنوان التنبيه *"}),e.jsx(z,{id:"title",placeholder:"عنوان التنبيه...",...t.register("title")}),t.formState.errors.title&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.formState.errors.title.message})]}),e.jsxs("div",{children:[e.jsx(y,{htmlFor:"target",children:"المستقبلين *"}),e.jsxs(V,{value:t.watch("target"),onValueChange:s=>t.setValue("target",s),children:[e.jsx(F,{children:e.jsx(I,{})}),e.jsxs(L,{children:[e.jsx(n,{value:"all",children:"جميع المستخدمين"}),e.jsx(n,{value:"head",children:"رؤساء الأسر فقط"}),e.jsx(n,{value:"admin",children:"المشرفين فقط"}),e.jsx(n,{value:"urgent",children:"تنبيه عاجل (كل المستخدمين)"}),e.jsx(n,{value:"specific",children:"مستخدمين محددين"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[t.watch("target")==="all"&&"سيتم إرسال التنبيه لجميع المستخدمين (الإدارة ورؤساء الأسر).",t.watch("target")==="head"&&"سيتم إرسال التنبيه لجميع رؤساء الأسر فقط.",t.watch("target")==="urgent"&&"سيتم إرسال تنبيه عاجل لجميع المستخدمين (سيظهر بشكل بارز).",t.watch("target")==="specific"&&"اختر رؤساء الأسر الذين تريد إرسال التنبيه لهم.",t.watch("target")==="admin"&&"سيتم إرسال التنبيه لجميع المشرفين فقط."]}),t.formState.errors.target&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.formState.errors.target.message})]}),t.watch("target")==="specific"&&e.jsxs("div",{children:[e.jsx(y,{htmlFor:"recipients",children:"اختر رؤساء الأسر"}),e.jsxs("div",{className:"space-y-2 md:space-y-0 md:flex md:gap-2 mb-2",children:[e.jsx(z,{placeholder:"بحث بالاسم أو رقم الهوية...",value:b,onChange:s=>H(s.target.value),className:"w-full md:w-48"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:flex md:gap-2",children:[e.jsxs(V,{value:g,onValueChange:Q,children:[e.jsx(F,{className:"w-full md:w-32",children:e.jsx(I,{children:g==="all"?"كل الفروع":g})}),e.jsxs(L,{children:[e.jsx(n,{value:"all",children:"كل الفروع"}),G.map(s=>e.jsx(n,{value:s,children:s},s))]})]}),e.jsxs(V,{value:p,onValueChange:U,children:[e.jsx(F,{className:"w-full md:w-32",children:e.jsx(I,{children:p==="all"?"كل الحالات":p})}),e.jsxs(L,{children:[e.jsx(n,{value:"all",children:"كل الحالات الاجتماعية"}),J.map(s=>e.jsx(n,{value:s,children:s},s))]})]})]})]}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded p-2 bg-background",children:X.map(s=>{var r;return e.jsxs("label",{className:"flex items-center gap-2 py-1 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:((r=t.watch("recipients"))==null?void 0:r.includes(s.userId))||!1,onChange:o=>{const i=t.watch("recipients")||[];o.target.checked?t.setValue("recipients",[...i,s.userId]):t.setValue("recipients",i.filter(f=>f!==s.userId))}}),e.jsxs("span",{children:[s.husbandName," (",s.husbandID,")"]})]},s.userId)})}),t.formState.errors.recipients&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.formState.errors.recipients.message})]}),e.jsxs("div",{children:[e.jsx(y,{htmlFor:"message",children:"نص الرسالة *"}),e.jsx(je,{id:"message",rows:4,placeholder:"اكتب رسالتك هنا...",...t.register("message")}),t.formState.errors.message&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:t.formState.errors.message.message})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-0 sm:space-x-2 sm:space-x-reverse pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>c(!1),className:"w-full sm:w-auto",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:k.isPending,className:"bg-primary text-primary-foreground w-full sm:w-auto",children:k.isPending?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"h-4 w-4 ml-2 animate-pulse"}),"جاري الإرسال..."]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"h-4 w-4 ml-2"}),"إرسال التنبيه"]})})]})]})]})})]})})}export{Pe as default};
